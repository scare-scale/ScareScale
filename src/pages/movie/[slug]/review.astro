---
import MainLayout from '../../../layouts/MainLayout.astro';
import { Image } from 'astro:assets';
import { movies } from '../../../lib/movies';
import { isLoggedIn, submitReview } from '../../../lib/supabase';
import { Categories } from '../../../models/Categories';
import { Review as MovieReview } from '../../../models/Review';

export const prerender = false;

const { slug } = Astro.params;
let error = '';
let success = '';

if (!slug) {
  return Astro.redirect('/');
}

if (!await isLoggedIn()) {
  return Astro.redirect(`/auth?referrer=${Astro.url.href}`);
}

const movie = movies.getBySlug(slug);

if (!movie) {
  return Astro.redirect('/');
}

if (Astro.request.method === 'POST') {
  const formData = await Astro.request.formData();

  const categories: Categories = new Categories(
    Number(formData.get('gore') || 0),
    Number(formData.get('creepy') || 0),
    Number(formData.get('suspense') || 0),
    Number(formData.get('jumpscares') || 0),
    Number(formData.get('psychological') || 0),
  );

  const content = formData.get('content')?.toString() || '';

  const review = MovieReview.userReview(categories, content);

  try {
    const { error: reviewError } = await submitReview(movie, review);
    if (reviewError) {
      error = reviewError.message;
    } else {
      success = 'Your review has been submitted.';
    }
  } catch (err) {
    error = 'Something went wrong.';
  }
}
---

<MainLayout>
  <div class="flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
    <div class="max-w-2xl w-full space-y-8 bg-gray-50 p-10">
      <!-- Movie Header -->
      <div class="bg-white rounded-lg shadow-sm p-6 mb-8">
        <div class="flex items-start space-x-4">
          <Image
            src={movie.posterUrl}
            alt={movie.name}
            width={120}
            height={180}
            class="rounded-lg shadow-sm"
          />
          <div class="flex-1">
            <h1 class="text-2xl font-bold text-gray-900 mb-2">{movie.name}</h1>
            <p class="text-gray-600 mb-4">{movie.releaseYear}</p>
            <p class="text-gray-700 text-sm leading-relaxed">{movie.synopsis}</p>
          </div>
        </div>
      </div>

      <!-- Review Form -->
      <div class="bg-white rounded-lg shadow-sm p-6">
        <h2 class="text-xl font-bold text-gray-900 mb-6">Add Your Review</h2>

        <form method="POST" class="space-y-6">
          <div class="grid grid-cols-2 gap-6">
            <div>
              <label for="gore" class="flex items-center gap-2 text-sm font-medium text-gray-700 mb-2">
                <img class="w-6 h-6 flex-none" src="/icons/categories/gore.svg" alt="Gore icon" />
                Gore
              </label>
              <input
                type="number"
                id="gore"
                name="gore"
                min="0"
                max="10"
                required
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500"
                placeholder="0–10"
              />
            </div>
          
            <div>
              <label for="creepy" class="flex items-center gap-2 text-sm font-medium text-gray-700 mb-2">
                <img class="w-6 h-6 flex-none" src="/icons/categories/creepy.svg" alt="Creepy icon" />
                Creepy
              </label>
              <input
                type="number"
                id="creepy"
                name="creepy"
                min="0"
                max="10"
                required
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500"
                placeholder="0–10"
              />
            </div>
          
            <div>
              <label for="suspense" class="flex items-center gap-2 text-sm font-medium text-gray-700 mb-2">
                <img class="w-6 h-6 flex-none" src="/icons/categories/suspense.svg" alt="Suspense icon" />
                Suspense
              </label>
              <input
                type="number"
                id="suspense"
                name="suspense"
                min="0"
                max="10"
                required
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500"
                placeholder="0–10"
              />
            </div>
          
            <div>
              <label for="jumpscares" class="flex items-center gap-2 text-sm font-medium text-gray-700 mb-2">
                <img class="w-6 h-6 flex-none" src="/icons/categories/jumpscares.svg" alt="Jumpscares icon" />
                Jumpscares
              </label>
              <input
                type="number"
                id="jumpscares"
                name="jumpscares"
                min="0"
                max="10"
                required
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500"
                placeholder="0–10"
              />
            </div>
          
            <div class="col-span-2">
              <label for="psychological" class="flex items-center gap-2 text-sm font-medium text-gray-700 mb-2">
                <img class="w-6 h-6 flex-none" src="/icons/categories/psychological.svg" alt="Psychological icon" />
                Psychological
              </label>
              <input
                type="number"
                id="psychological"
                name="psychological"
                min="0"
                max="10"
                required
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500"
                placeholder="0–10"
              />
            </div>
          </div>

          <div>
            <label for="content" class="block text-sm font-medium text-gray-700 mb-2">Comments (Optional)</label>
            <textarea id="content" name="content" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500" placeholder="Share your thoughts about this movie..."></textarea>
          </div>

          {error && <div class="text-red-600 text-sm">{error}</div>}
          {success && <div class="text-green-600 text-sm">{success}</div>}

          <div class="flex space-x-4">
            <button type="submit" class="flex-1 bg-red-600 text-white py-2 px-4 rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 font-medium">
              Submit Review
            </button>
            <a href={`/movie/${movie.slug}`} class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 font-medium">
              Cancel
            </a>
          </div>
        </form>
      </div>
    </div>
  </div>
</MainLayout>